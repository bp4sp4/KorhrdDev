# 매출등록 페이지 검색 기능 동작 원리 및 이슈 설명

## 📋 목차

1. [문제 상황](#문제-상황)
2. [시스템 구조 및 데이터 흐름](#시스템-구조-및-데이터-흐름)
3. [검색 동작 규칙](#검색-동작-규칙)
4. [왜 이런 현상이 발생하는가?](#왜-이런-현상이-발생하는가)
5. [해결 방법](#해결-방법)
6. [주의사항 및 위험 구간](#주의사항-및-위험-구간)

---

## 🔍 문제 상황

### 발생 현상

**장은혜 본부장**이 매출등록 페이지에서 다음과 같은 현상을 경험했습니다:

1. ❌ **검색창에 "서인식" 입력** → 결과가 나오지 않음
2. ✅ **담당자 필터에서 "서인식" 선택** → 데이터가 정상적으로 표시됨
3. ✅ **등록기간을 1월로 설정 후 "서인식" 검색** → 데이터가 정상적으로 표시됨

### 왜 이런 일이 발생하는가?

이는 시스템의 **기본 필터링 규칙** 때문입니다.

###예를 들어 장은혜 본부장의 상황

**장은혜 본부장의 권한:**

- 본부장 권한으로 **자신이 등록한 매출 데이터**는 항상 볼 수 있음
- 본부장 권한으로 **다른 담당자들의 데이터**도 볼 수 있음 (권한 범위 내)

**문제 상황:**

- 장은혜 본부장이 **자신이 등록한 데이터**는 정상적으로 보이고 검색도 가능함
- 하지만 **다른 담당자(예: 서인식)의 데이터**를 검색창에서 찾으려고 했을 때 결과가 나오지 않음

**원인:**

1. **필터가 없을 때 본부장이 볼 수 있는 데이터**

   - 본부장 권한: **자신의 지점 전체 데이터** + **자신이 등록한 매출** (다른 지점 제외)
   - 그 다음 **현재 월 필터**가 적용되어 → 현재 월 데이터만 화면에 표시됨
   - 예: 장은혜 본부장의 지점에 서인식이 있다면, 서인식의 현재 월 데이터도 보임
   - 하지만 서인식의 데이터가 다른 월(예: 2025년 12월)에 등록되어 있다면 → 현재 월 필터에 의해 숨겨짐

2. **검색은 "이미 화면에 표시된 데이터"에서만 작동**

   - 검색창에 입력하면, **현재 화면에 표시된 데이터**에서만 검색을 수행함
   - 필터가 없을 때: 자신의 지점 + 자신의 매출 중 **현재 월 데이터**에서만 검색
   - 따라서 다른 담당자(서인식)의 데이터가 다른 월에 있다면 검색 결과에 포함되지 않음

3. **필터를 걸어야 다른 월 데이터도 검색 가능**
   - 등록기간, 결제기간, 담당자 필터를 설정하면 → 필터가 활성화되어 → **현재 월 제한이 해제**됨
   - 권한 범위 내의 **모든 월의 데이터**가 검색 대상에 포함됨
   - 이때 검색하면 다른 담당자의 과거 월 데이터도 찾을 수 있음

**요약:**

- 필터 없음 → 자신의 지점 + 자신의 매출 중 현재 월만 보임 → 현재 월 데이터에서만 검색
- 필터 있음 → 권한 범위 내 모든 월 데이터 보임 → 모든 월 데이터에서 검색 가능

**해결:**

- 등록기간 필터를 설정하면 → 검색 범위가 확장되어 → 다른 월의 데이터도 검색 가능
- 담당자 필터를 사용하면 → 필터가 활성화되어 → 전체 데이터 범위에서 해당 담당자 데이터 표시

---

## 🏗️ 시스템 구조 및 데이터 흐름

### 데이터 필터링 단계

```
전체 데이터 (allCrmData)
    ↓
[1단계] 권한별 데이터 필터링 (getFilteredDataSource)
    ↓
[2단계] 현재 년월 필터링 (기본 동작)
    ↓
[3단계] 검색어 필터링
    ↓
[4단계] 추가 필터 적용 (등록기간, 결제기간, 담당자)
    ↓
최종 표시 데이터
```

### 핵심 규칙

**매출등록 페이지는 기본적으로 "권한별로 필터링된 현재 년월 데이터만" 표시합니다.**

- **일반 사용자**: 자신이 등록한 현재 년월 데이터만 표시
- **본부장/팀장**: 자신이 등록한 현재 년월 데이터 + 권한 범위 내 지점/팀 데이터 (필터 없을 때는 주로 자신의 데이터가 먼저 보임)
- **마스터 어드민**: 모든 데이터 표시 (현재 월 제한 없음)
- 예: 2026년 1월에 접속하면 → 2026년 1월에 등록된 데이터만 기본으로 보여줍니다
- 다른 월(12월, 11월 등)의 데이터는 기본적으로 숨겨집니다

---

## 📐 검색 동작 규칙

### 규칙 1: 기본 동작 (필터 없음)

```
사용자가 필터를 설정하지 않은 상태
    ↓
권한별로 필터링된 현재 년월 데이터만 표시
  - 일반 사용자: 자신이 등록한 현재 월 데이터
  - 본부장/팀장: 자신이 등록한 현재 월 데이터 (주로)
    ↓
검색창에 "서인식" 입력
    ↓
현재 화면에 표시된 데이터(자신의 매출)에서만 검색
    ↓
결과: 자신의 매출에 서인식 데이터가 없으면 → 검색 결과 없음
```

**예시 (본부장의 경우):**

- 현재: 2026년 1월
- 장은혜 본부장이 등록한 데이터: 2026년 1월에 등록됨 → ✅ 보임
- 서인식이 등록한 데이터 (같은 지점):
  - 2026년 1월에 등록됨 → ✅ 보임 (같은 지점이므로)
  - 2025년 12월에 등록됨 → ❌ 안 보임 (현재 월 필터에 의해 숨겨짐)
- 검색어: "서인식" →
  - 2026년 1월 데이터가 있으면 ✅ 검색됨
  - 2025년 12월 데이터만 있으면 ❌ 검색 안 됨 (현재 월 필터에 의해 화면에 없음)

### 규칙 2: 필터 적용 시

```
사용자가 필터를 설정한 상태
    ↓
필터가 적용되었다고 인식
    ↓
전체 데이터(권한 범위 내)에서 검색
    ↓
검색창에 "서인식" 입력
    ↓
전체 데이터 중에서 "서인식" 검색
    ↓
결과: 모든 월의 서인식 데이터 표시 ✅
```

**적용되는 필터:**

- ✅ 등록기간선택
- ✅ 결제기간선택
- ✅ 담당자 선택

---

## 🤔 왜 이런 현상이 발생하는가?

### 시스템 설계 의도

1. **성능 최적화**

   - 매출 데이터가 많을 수 있으므로, 기본적으로 현재 월 데이터만 로드하여 빠른 응답 속도 유지

2. **사용 편의성**

   - 대부분의 사용자는 "이번 달 매출"을 주로 확인하므로, 기본값을 현재 월로 설정

3. **데이터 보안**
   - 권한에 따라 접근 가능한 데이터 범위를 제한

### 문제점

**검색 기능이 "이미 화면에 표시된 데이터"에서만 작동합니다.**

```
[잘못된 기대]
검색창에 입력 → 권한 범위 내 전체 데이터에서 검색 → 결과 표시

[실제 동작]
검색창에 입력 → 현재 화면에 표시된 데이터(기본적으로 자신의 현재 월 매출)에서만 검색 → 결과 표시
```

**본부장/팀장의 경우:**

- 권한상으로는 자신의 지점/팀 내 다른 담당자 데이터도 볼 수 있지만
- 필터를 설정하지 않으면 **현재 월 데이터만** 보임
- 같은 지점/팀의 다른 담당자라도, 다른 월에 등록된 데이터는 화면에 표시되지 않음
- 따라서 검색도 현재 월 데이터에서만 작동하여, 다른 월의 데이터를 찾을 수 없음

---

## ✅ 해결 방법

### 방법 1: 등록기간 필터 사용 (권장)

1. **등록기간선택** 버튼 클릭
2. 원하는 기간 설정 (예: 2025년 12월 ~ 2026년 1월)
3. 검색창에 "서인식" 입력
4. ✅ 결과 표시됨

**이유:** 등록기간을 설정하면 필터가 활성화되어 전체 데이터 범위에서 검색됩니다.

### 방법 2: 담당자 필터 사용

1. **담당자 선택** 드롭다운 클릭
2. "서인식" 선택
3. ✅ 데이터 표시됨

**이유:** 담당자 필터를 설정하면 필터가 활성화되어 전체 데이터 범위에서 검색됩니다.

### 방법 3: 결제기간 필터 사용

1. **결제기간선택** 버튼 클릭
2. 원하는 기간 설정
3. 검색창에 "서인식" 입력
4. ✅ 결과 표시됨

---

## ⚠️ 주의사항 및 위험 구간

### 위험 구간 1: 기본 필터 동작 변경

**위치:** `src/app/sales/page.tsx` (1465-1469줄)

```typescript
// 필터가 없으면 현재 년월 데이터만 표시
if (!hasActiveFilters && !isMasterAdmin) {
  if (!isCurrentMonth(item)) {
    return false;
  }
}
```

**코드 설명:**

이 코드는 **"현재 년월 데이터만 표시하는 기본 필터"**를 구현합니다.

- `!hasActiveFilters`: 사용자가 필터를 설정하지 않았는지 확인
  - 등록기간, 결제기간, 담당자 필터가 모두 없을 때만 `true`
- `!isMasterAdmin`: 마스터 어드민이 아닌지 확인
  - 마스터 어드민은 이 필터의 영향을 받지 않음
- `!isCurrentMonth(item)`: 데이터가 현재 년월이 아닌지 확인
  - 현재 년월이 아니면 `return false`로 필터링됨 (표시 안 됨)

**동작 예시:**

- 현재: 2026년 1월
- 데이터 A: 2026년 1월 등록 → ✅ 표시됨
- 데이터 B: 2025년 12월 등록 → ❌ 필터링됨 (표시 안 됨)
- 마스터 어드민: 모든 데이터 표시 (이 필터 무시)

**위험성:**

- 이 로직을 변경하면 모든 사용자에게 영향을 미칩니다
- 성능 저하 가능성 (전체 데이터 로드)
- 사용자 혼란 가능성 (예상치 못한 데이터 표시)

**변경 시 고려사항:**

- 성능 테스트 필수
- 사용자 교육 필요
- 권한별 동작 확인 필요

### 위험 구간 2: 검색 로직 변경

**위치:** `src/app/sales/page.tsx` (1476-1489줄)

```typescript
const searchMatch =
  searchTerm === "" ||
  (item.customerName || "").toLowerCase().includes(searchTerm.toLowerCase()) ||
  // ... 기타 검색 조건
```

**코드 설명:**

이 코드는 **"검색어와 데이터가 일치하는지 확인하는 로직"**입니다.

- `searchTerm === ""`: 검색어가 비어있으면 모든 데이터와 일치 (필터링 안 함)
- `(item.customerName || "").toLowerCase().includes(...)`: 고객명에서 검색어 찾기
  - `|| ""`: 고객명이 없으면 빈 문자열로 처리 (에러 방지)
  - `.toLowerCase()`: 대소문자 구분 없이 검색
  - `.includes()`: 부분 문자열 검색 (예: "서인식" 입력 시 "서인식", "서인식님" 모두 매칭)

**전체 검색 조건 (실제 코드):**

1. 고객명 (`customerName`)
2. 연락처 (`contact`) - 하이픈/공백 제거 후 검색
3. 기관명 (`institution`) - 공백 제거 후 검색
4. 담당자 (`manager`)
5. 소속팀장 (`getTeamLeader(manager)`)

**동작 예시:**

- 검색어: "서인식"
- 데이터 A: 고객명 "서인식" → ✅ 매칭
- 데이터 B: 담당자 "서인식" → ✅ 매칭
- 데이터 C: 고객명 "김서인식" → ✅ 매칭 (부분 일치)
- 데이터 D: 고객명 "홍길동" → ❌ 매칭 안 됨

**중요한 점:**

- 검색은 **이미 필터링된 데이터**에서만 작동
- 위의 "현재 년월 필터"를 통과한 데이터에서만 검색 수행
- 따라서 현재 월이 아닌 데이터는 검색 대상에서 제외됨

**위험성:**

- 검색 범위를 변경하면 기존 사용 패턴과 충돌 가능
- 검색 성능에 영향

### 외부 영향 지점

1. **데이터베이스 쿼리**

   - `allCrmData`: 전체 데이터 로드
   - `crmData`: 권한별 필터링된 데이터

2. **권한 시스템**

   - `userPermission`: 사용자 권한에 따라 접근 가능한 데이터 범위 결정
   - `getFilteredDataSource()`: 권한별 데이터 소스 결정

3. **필터 상태 관리**
   - `hasFilterInteraction`: 사용자가 필터를 조작했는지 추적
   - `registrationDateRange`, `paymentDateRange`, `filters.managers`: 필터 상태

---

## 📊 로그 및 복구

### 문제 발생 시 확인 사항

1. **브라우저 콘솔 로그 확인**

   - 검색어 입력 시 필터링된 데이터 개수 확인
   - `filteredDataSource.length` 확인

2. **데이터 확인**

   - 검색 대상 데이터의 `registrationDate` 확인
   - 현재 월과 일치하는지 확인

3. **권한 확인**
   - 사용자 권한(`userPermission`) 확인
   - 접근 가능한 데이터 범위 확인

### 복구 방법

**사용자 안내:**

1. 등록기간 또는 결제기간 필터를 설정한 후 검색
2. 담당자 필터를 사용하여 특정 담당자 데이터 확인

**개발자 복구:**

- 필터 상태 초기화
- 검색어 초기화
- 페이지 새로고침

---

## 📝 요약

### 핵심 포인트

1. **매출등록 페이지는 기본적으로 현재 월 데이터만 표시합니다**
2. **검색은 "이미 필터링된 데이터"에서만 작동합니다**
3. **필터를 설정하면 전체 데이터 범위에서 검색할 수 있습니다**

### 사용자 가이드

**과거 데이터를 검색하려면:**

1. 등록기간선택 또는 결제기간선택 버튼 클릭
2. 원하는 기간 설정
3. 검색어 입력

**특정 담당자 데이터를 찾으려면:**

1. 담당자 선택 드롭다운 사용
2. 또는 등록기간 설정 후 검색

### 본부장/팀장 사용자를 위한 안내

**본부장이나 팀장 권한을 가진 사용자의 경우:**

- ✅ **자신이 등록한 데이터**: 필터 없을 때 기본적으로 보이고 검색 가능 (현재 월 데이터만)
- ⚠️ **다른 담당자의 데이터**: 권한상 볼 수 있지만, 필터를 설정하지 않으면 화면에 표시되지 않아 검색할 수 없음

**다른 담당자의 데이터를 찾으려면:**

**방법 1: 담당자 필터 사용 (가장 간단)**

1. **담당자 선택** 드롭다운에서 해당 담당자 선택
2. ✅ 해당 담당자의 모든 데이터 표시됨 (기간 제한 없음)
3. 필요시 검색창에서 추가 검색 가능

**방법 2: 등록기간 필터 사용**

1. **등록기간선택** 또는 **결제기간선택** 버튼을 먼저 클릭
2. 해당 담당자의 데이터가 등록된 기간을 설정 (예: 2025년 12월 ~ 2026년 1월)
3. 필터가 활성화되어 권한 범위 내 모든 담당자 데이터가 검색 대상에 포함됨
4. 검색창에 담당자 이름 또는 고객명 입력
5. ✅ 결과 표시됨

**핵심 포인트:**

- 필터를 설정해야 다른 담당자 데이터가 화면에 표시됨
- 화면에 표시된 데이터에서만 검색이 작동함

---

## 🔧 시스템 경계

### 변경 시 영향 범위

- **영향 받는 페이지:** 매출등록 페이지 (`/sales`)
- **영향 받는 사용자:** 모든 매출등록 페이지 사용자
- **영향 받는 기능:** 검색, 필터링, 데이터 표시

### 데이터 흐름 경계

```
사용자 입력
    ↓
필터 상태 관리 (React State)
    ↓
데이터 필터링 로직
    ↓
UI 업데이트
```

### 규칙이 있는 지점

1. **현재 월 필터:** 필터가 없을 때만 적용
2. **검색 범위:** 필터링된 데이터 소스 내에서만 검색
3. **권한 체크:** 사용자 권한에 따라 데이터 소스 결정

---
